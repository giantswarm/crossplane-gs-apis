apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  creationTimestamp: null
  labels:
    component: networking
    provider: aws
    type: vpc
  name: peeredvpc
spec:
  compositeTypeRef:
    apiVersion: xnetworks.crossplane.giantswarm.io/v1alpha1
    kind: PeeredVpcNetwork
  mode: Pipeline
  pipeline:
  - functionRef:
      name: function-network-discovery
    input:
      apiVersion: xnetworks.crossplane.giantswarm.io/v1beta1
      kind: Input
      metadata:
        creationTimestamp: null
      spec:
        patchTo: ""
        providerConfigRef: ""
        regionRef: ""
        vpcRef: spec.peering.vpcName
    step: network-discovery
  - functionRef:
      name: function-go-templating
    input:
      apiVersion: gotemplating.fn.crossplane.io/v1beta1
      inline:
        template: |-
          #
          # Wait for the claim name to be populated before setting the appName
          #
          {{ $appName := "" }}
          {{ $claimRef := .observed.composite.resource.spec.claimRef }}
          {{ if not ( empty $claimRef ) }}
              {{ $appName = index $claimRef "name" }}
          {{ end }}

          #
          # Common information required from the composite
          #
          {{ $labels := .observed.composite.resource.metadata.labels }}
          {{ $region  := .observed.composite.resource.spec.region }}
          {{ $subnets := .observed.composite.resource.spec.subnets }}
          {{ $tags := .observed.composite.resource.spec.tags }}
          {{ $zones := .observed.composite.resource.spec.subnets.zones }}
          {{ $dp := .observed.composite.resource.spec.deletionPolicy }}

          #
          # Create public and private subnet sets
          #
          {{ $types := list "public" "private" }}
          {{ $zoneLen := len $zones }}

          {{ $maxSubnets := list 1 2 3 }}

          {{ range $num := $maxSubnets }}
          #
          # Create one subnet set for each type (public / private)
          {{ range $type := $types }}

              # Public subnets are the first 3 in the Cidr list from the claim
              {{ $cidrs := slice $subnets.cidrBlocks 0 $zoneLen }}
              {{ if eq $type "private" }}
                  {{ $cidrs = slice $subnets.cidrBlocks $zoneLen (len $subnets.cidrBlocks) }}
              {{ end }}
          #
          #  Create SubnetSet for {{ $type }} subnets
          ---
          apiVersion: xnetworks.crossplane.giantswarm.io/v1alpha1
          kind: SubnetSet
          metadata:
          annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: {{ $type }}-subnets-{{ $num }}
          labels:
              {{range $key, $value := $labels }}
              {{ $key }}: {{ $value }}
              {{ end }}
              visibility: {{ $type }}
          name: {{ $appName }}-{{ $type }}-{{ $num }}
          spec:
          claimRef:
          {{ range $key, $value := $claimRef }}
              {{ $key }}: {{ $value }}
          {{ end }}
          deletionPolicy: {{ $dp }}
          region: {{ $region }}
          subnets:
              a:
              zone: {{ index $zones 0 }}
              cidrBlock: {{ index $cidrs 0 }}
              b:
              zone: {{ index $zones 1 }}
              cidrBlock: {{ index $cidrs 1 }}
              c:
              zone: {{ index $zones 2 }}
              cidrBlock: {{ index $cidrs 2 }}
          type: {{ $type }}
          tags:
          {{ range $key, $value := $tags }}
              {{ $key }}: {{ $value }}
          {{ end }}
          {{ end }} # end range $types
          {{ end }} # end range maxSubnets

          #
          # Create nat gateways and elastic ips
          #
          {{ $index := 0 }}
          {{ $pubsubs := .observed.composite.resource.status.publicSubnets }}
          {{ $pubrtbls := .observed.composite.resource.status.publicRouteTables }}
          {{ $prirtbls := .observed.composite.resource.status.privateRouteTables }}
          {{ $igwId := .observed.composite.resource.status.igwId }}

          # Create EIP, NAT Gateway, and Route for each zone
          {{ range $k, $v := $zones }}
              {{ $az := printf "%s%s" $region $v }}
              {{ $pubsn := "" }}
              {{ $prirtbl := "" }}
              {{ $pubrtbl := "" }}

              # Get the public subnet ids when all 3 are created
              {{ if not (empty $pubsubs) }}
                  {{ if eq (len (keys $pubsubs)) $zoneLen }}
                      {{ $pubsn = get $pubsubs (index ( keys $pubsubs | sortAlpha ) $k) }}
                  {{ end }}
              {{ end }}

              # Get the private route table ids when all 3 are created
              {{ if not (empty $prirtbls) }}
                  {{ if eq (len ( keys $prirtbls )) $zoneLen }}
                      {{ $prirtbl = get $prirtbls (index ( keys $prirtbls | sortAlpha ) $k) }}
                  {{ end }}
              {{ end }}

              # Get the public route table ids when all 3 are created
              {{ if not (empty $pubrtbls) }}
                  {{ if eq (len (keys $pubrtbls )) $zoneLen }}
                      {{ $pubrtbl = get $pubrtbls (index ( keys $pubrtbls | sortAlpha ) $k) }}
                  {{ end }}
              {{ end }}
          ---
          apiVersion: ec2.aws.upbound.io/v1beta1
          kind: EIP
          metadata:
          annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: eip-{{ $index }}
          name: {{ $appName }}-ngw-{{ $az }}
          labels:
              availabilityZone: {{ $az }}
              utilization: nat-gateway
          spec:
          forProvider:
              region: {{ $region }}
              domain: vpc
              tags:
              Name: {{ $appName }}-{{ $az }}
          ---
          apiVersion: ec2.aws.upbound.io/v1beta1
          kind: NATGateway
          metadata:
          annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: nat-gateway-{{ $index }}
          name: {{ $appName }}-{{ $az }}
          labels:
              availabilityZone: {{ $az }}
          spec:
          forProvider:
              region: {{ $region }}
              allocationIdSelector:
              matchControllerRef: true
              matchLabels:
                  availabilityZone: {{ $az }}
              subnetId: {{ if not (empty $pubsn) }}{{ $pubsn }}{{ end }}
              tags:
              Name: {{ $appName }}-{{ $az }}
          ---
          apiVersion: ec2.aws.upbound.io/v1beta1
          kind: Route
          metadata:
          annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: ngw-route-{{ $index }}
          name: {{ $appName }}-ngw-{{ $az }}
          labels:
              availabilityZone: {{ $az }}
          spec:
          forProvider:
              destinationCidrBlock: 0.0.0.0/0
              natGatewayIdSelector:
              matchControllerRef: true
              matchLabels:
                  availabilityZone: {{ $az }}
              routeTableId: {{ if not (empty $prirtbl) }}{{ $prirtbl }}{{ end }}
              region: {{ $region }}
          ---
          apiVersion: ec2.aws.upbound.io/v1beta1
          kind: Route
          metadata:
          annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: igw-route-{{ $index }}
          name: {{ $appName }}-igw-{{ $az }}
          labels:
              availabilityZone: {{ $az }}
          spec:
          forProvider:
              destinationCidrBlock: 0.0.0.0/0
              gatewayIdSelector:
              matchControllerRef: true
              routeTableId: {{ if not (empty $pubrtbl) }}{{ $pubrtbl }}{{ end }}
              region: {{ $region }}
          {{ $index = add $index 1 }}
          {{ end }} # end range $zones
      kind: GoTemplate
      metadata:
        creationTimestamp: null
      source: Inline
    step: go-templating
  - functionRef:
      name: function-patch-and-transform
    input:
      apiVersion: pt.crossplane.io/v1beta1
      kind: Resources
      metadata:
        creationTimestamp: null
      patchSets:
      - name: metadata
        patches:
        - fromFieldPath: metadata.labels
          policy:
            toFieldPath: MergeObjects
          toFieldPath: metadata.labels
          type: FromCompositeFieldPath
        - fromFieldPath: spec.region
          toFieldPath: metadata.labels.region
          type: FromCompositeFieldPath
        - fromFieldPath: spec.providerConfigRef
          toFieldPath: spec.providerConfigRef
          type: FromCompositeFieldPath
        - fromFieldPath: spec.deletionPolicy
          toFieldPath: spec.deletionPolicy
          type: FromCompositeFieldPath
      - name: commontags
        patches:
        - fromFieldPath: spec.tags.common
          policy:
            toFieldPath: MergeObjects
          toFieldPath: spec.forProvider.tags
          type: FromCompositeFieldPath
        - fromFieldPath: metadata.labels
          policy:
            toFieldPath: MergeObjects
          toFieldPath: spec.forProvider.tags
          type: FromCompositeFieldPath
        - fromFieldPath: spec.region
          toFieldPath: spec.forProvider.tags.region
          type: FromCompositeFieldPath
      resources:
      - base:
          apiVersion: ec2.aws.upbound.io/v1beta1
          kind: VPC
          metadata:
            creationTimestamp: null
          spec:
            forProvider:
              enableDnsHostnames: true
              enableDnsSupport: true
              region: null
            initProvider: {}
          status:
            atProvider: {}
        name: vpc
        patches:
        - fromFieldPath: spec.region
          toFieldPath: spec.forProvider.region
          type: FromCompositeFieldPath
        - fromFieldPath: spec.vpcCidr
          toFieldPath: spec.forProvider.cidrBlock
          type: FromCompositeFieldPath
        - patchSetName: commontags
          type: PatchSet
        - fromFieldPath: spec.claimRef.name
          toFieldPath: spec.forProvider.tags.Name
          type: FromCompositeFieldPath
        - patchSetName: metadata
          type: PatchSet
        - combine:
            strategy: string
            string:
              fmt: '%s-%s'
            variables:
            - fromFieldPath: spec.claimRef.name
            - fromFieldPath: spec.region
          toFieldPath: metadata.name
          type: CombineFromComposite
        - fromFieldPath: status.atProvider.id
          toFieldPath: status.id
          type: ToCompositeFieldPath
      - base:
          apiVersion: ec2.aws.upbound.io/v1beta1
          kind: DefaultSecurityGroup
          metadata:
            creationTimestamp: null
          spec:
            forProvider:
              region: null
              vpcIdSelector:
                matchControllerRef: true
            initProvider: {}
          status:
            atProvider: {}
        name: default-sg-control
        patches:
        - fromFieldPath: spec.region
          toFieldPath: spec.forProvider.region
          type: FromCompositeFieldPath
        - patchSetName: commontags
          type: PatchSet
        - patchSetName: metadata
          type: PatchSet
        - combine:
            strategy: string
            string:
              fmt: '%s-%s'
            variables:
            - fromFieldPath: spec.claimRef.name
            - fromFieldPath: spec.region
          toFieldPath: metadata.name
          type: CombineFromComposite
      - base:
          apiVersion: ec2.aws.upbound.io/v1beta1
          kind: InternetGateway
          metadata:
            creationTimestamp: null
          spec:
            forProvider:
              region: null
              vpcIdSelector:
                matchControllerRef: true
            initProvider: {}
          status:
            atProvider: {}
        name: internet-gateway
        patches:
        - fromFieldPath: spec.region
          toFieldPath: spec.forProvider.region
          type: FromCompositeFieldPath
        - patchSetName: commontags
          type: PatchSet
        - patchSetName: metadata
          type: PatchSet
        - combine:
            strategy: string
            string:
              fmt: '%s-%s-igw'
            variables:
            - fromFieldPath: spec.claimRef.name
            - fromFieldPath: spec.region
          toFieldPath: spec.forProvider.tags.Name
          type: CombineFromComposite
        - combine:
            strategy: string
            string:
              fmt: '%s-%s'
            variables:
            - fromFieldPath: spec.claimRef.name
            - fromFieldPath: spec.region
          toFieldPath: metadata.name
          type: CombineFromComposite
      - name: public-subnets-0
        patches:
        - patchSetName: metadata
          type: PatchSet
        - fromFieldPath: status.id
          toFieldPath: spec.vpcId
          type: FromCompositeFieldPath
        - fromFieldPath: status.subnets.a
          toFieldPath: status.subnets.public[0].a
          type: ToCompositeFieldPath
        - fromFieldPath: status.routeTables.a
          toFieldPath: status.routeTables.public[0].a
          type: ToCompositeFieldPath
        - fromFieldPath: status.subnets.b
          toFieldPath: status.subnets.public[1].b
          type: ToCompositeFieldPath
        - fromFieldPath: status.routeTables.b
          toFieldPath: status.routeTables.public[1].b
          type: ToCompositeFieldPath
        - fromFieldPath: status.subnets.c
          toFieldPath: status.subnets.public[2].c
          type: ToCompositeFieldPath
        - fromFieldPath: status.routeTables.c
          toFieldPath: status.routeTables.public[2].c
          type: ToCompositeFieldPath
      - name: public-subnets-1
        patches:
        - patchSetName: metadata
          type: PatchSet
        - fromFieldPath: status.id
          toFieldPath: spec.vpcId
          type: FromCompositeFieldPath
        - fromFieldPath: status.subnets.a
          toFieldPath: status.subnets.public[0].a
          type: ToCompositeFieldPath
        - fromFieldPath: status.routeTables.a
          toFieldPath: status.routeTables.public[0].a
          type: ToCompositeFieldPath
        - fromFieldPath: status.subnets.b
          toFieldPath: status.subnets.public[1].b
          type: ToCompositeFieldPath
        - fromFieldPath: status.routeTables.b
          toFieldPath: status.routeTables.public[1].b
          type: ToCompositeFieldPath
        - fromFieldPath: status.subnets.c
          toFieldPath: status.subnets.public[2].c
          type: ToCompositeFieldPath
        - fromFieldPath: status.routeTables.c
          toFieldPath: status.routeTables.public[2].c
          type: ToCompositeFieldPath
      - name: public-subnets-2
        patches:
        - patchSetName: metadata
          type: PatchSet
        - fromFieldPath: status.id
          toFieldPath: spec.vpcId
          type: FromCompositeFieldPath
        - fromFieldPath: status.subnets.a
          toFieldPath: status.subnets.public[0].a
          type: ToCompositeFieldPath
        - fromFieldPath: status.routeTables.a
          toFieldPath: status.routeTables.public[0].a
          type: ToCompositeFieldPath
        - fromFieldPath: status.subnets.b
          toFieldPath: status.subnets.public[1].b
          type: ToCompositeFieldPath
        - fromFieldPath: status.routeTables.b
          toFieldPath: status.routeTables.public[1].b
          type: ToCompositeFieldPath
        - fromFieldPath: status.subnets.c
          toFieldPath: status.subnets.public[2].c
          type: ToCompositeFieldPath
        - fromFieldPath: status.routeTables.c
          toFieldPath: status.routeTables.public[2].c
          type: ToCompositeFieldPath
      - name: private-subnets-0
        patches:
        - patchSetName: metadata
          type: PatchSet
        - fromFieldPath: status.id
          toFieldPath: spec.vpcId
          type: FromCompositeFieldPath
        - fromFieldPath: status.subnets.a
          toFieldPath: status.subnets.private[0].a
          type: ToCompositeFieldPath
        - fromFieldPath: status.routeTables.a
          toFieldPath: status.routeTables.private[0].a
          type: ToCompositeFieldPath
        - fromFieldPath: status.subnets.b
          toFieldPath: status.subnets.private[1].b
          type: ToCompositeFieldPath
        - fromFieldPath: status.routeTables.b
          toFieldPath: status.routeTables.private[1].b
          type: ToCompositeFieldPath
        - fromFieldPath: status.subnets.c
          toFieldPath: status.subnets.private[2].c
          type: ToCompositeFieldPath
        - fromFieldPath: status.routeTables.c
          toFieldPath: status.routeTables.private[2].c
          type: ToCompositeFieldPath
      - name: private-subnets-1
        patches:
        - patchSetName: metadata
          type: PatchSet
        - fromFieldPath: status.id
          toFieldPath: spec.vpcId
          type: FromCompositeFieldPath
        - fromFieldPath: status.subnets.a
          toFieldPath: status.subnets.private[0].a
          type: ToCompositeFieldPath
        - fromFieldPath: status.routeTables.a
          toFieldPath: status.routeTables.private[0].a
          type: ToCompositeFieldPath
        - fromFieldPath: status.subnets.b
          toFieldPath: status.subnets.private[1].b
          type: ToCompositeFieldPath
        - fromFieldPath: status.routeTables.b
          toFieldPath: status.routeTables.private[1].b
          type: ToCompositeFieldPath
        - fromFieldPath: status.subnets.c
          toFieldPath: status.subnets.private[2].c
          type: ToCompositeFieldPath
        - fromFieldPath: status.routeTables.c
          toFieldPath: status.routeTables.private[2].c
          type: ToCompositeFieldPath
      - name: private-subnets-2
        patches:
        - patchSetName: metadata
          type: PatchSet
        - fromFieldPath: status.id
          toFieldPath: spec.vpcId
          type: FromCompositeFieldPath
        - fromFieldPath: status.subnets.a
          toFieldPath: status.subnets.private[0].a
          type: ToCompositeFieldPath
        - fromFieldPath: status.routeTables.a
          toFieldPath: status.routeTables.private[0].a
          type: ToCompositeFieldPath
        - fromFieldPath: status.subnets.b
          toFieldPath: status.subnets.private[1].b
          type: ToCompositeFieldPath
        - fromFieldPath: status.routeTables.b
          toFieldPath: status.routeTables.private[1].b
          type: ToCompositeFieldPath
        - fromFieldPath: status.subnets.c
          toFieldPath: status.subnets.private[2].c
          type: ToCompositeFieldPath
        - fromFieldPath: status.routeTables.c
          toFieldPath: status.routeTables.private[2].c
          type: ToCompositeFieldPath
      - name: eip-0
        patches:
        - patchSetName: metadata
          type: PatchSet
        - patchSetName: commontags
          type: PatchSet
      - name: eip-1
        patches:
        - patchSetName: metadata
          type: PatchSet
        - patchSetName: commontags
          type: PatchSet
      - name: eip-2
        patches:
        - patchSetName: metadata
          type: PatchSet
        - patchSetName: commontags
          type: PatchSet
      - name: nat-gateway-0
        patches:
        - patchSetName: metadata
          type: PatchSet
        - patchSetName: commontags
          type: PatchSet
        - fromFieldPath: status.atProvider.id
          toFieldPath: status.natGateways.a
          type: ToCompositeFieldPath
      - name: nat-gateway-1
        patches:
        - patchSetName: metadata
          type: PatchSet
        - patchSetName: commontags
          type: PatchSet
        - fromFieldPath: status.atProvider.id
          toFieldPath: status.natGateways.b
          type: ToCompositeFieldPath
      - name: nat-gateway-2
        patches:
        - patchSetName: metadata
          type: PatchSet
        - patchSetName: commontags
          type: PatchSet
        - fromFieldPath: status.atProvider.id
          toFieldPath: status.natGateways.c
          type: ToCompositeFieldPath
      - name: igw-route-0
        patches:
        - patchSetName: metadata
          type: PatchSet
      - name: igw-route-1
        patches:
        - patchSetName: metadata
          type: PatchSet
      - name: igw-route-2
        patches:
        - patchSetName: metadata
          type: PatchSet
      - name: ngw-route-0
        patches:
        - patchSetName: metadata
          type: PatchSet
      - name: ngw-route-1
        patches:
        - patchSetName: metadata
          type: PatchSet
      - name: ngw-route-2
        patches:
        - patchSetName: metadata
          type: PatchSet
    step: patch-and-transform
